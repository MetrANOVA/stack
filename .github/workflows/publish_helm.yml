name: Release Helm Charts

##
# Controls when the workflow will run
on:
  push:
    branches:
      - main
      # match version branches like 1.0.x, 2.1.x, etc.
      - '*.*.*'
  # Allows you to run this workflow manually from the Actions 
  workflow_dispatch:

##
# The jobs to run that wil publish helm charts
jobs:
  release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      # Ensure Chart.yaml version matches branch name for non-main branches
      - name: Ensure Chart Version Matches Branch
        id: version_check
        if: github.ref_name != 'main'
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          CHANGED=false
          
          # Find and process all Chart.yaml files in helm subdirectories
          for CHART_FILE in ./helm/*/Chart.yaml; do
            if [ -f "$CHART_FILE" ]; then
              CURRENT_VERSION=$(yq eval '.version' "$CHART_FILE")
              
              if [ "$CURRENT_VERSION" != "$BRANCH_NAME" ]; then
                echo "Version mismatch in $CHART_FILE: Chart has '$CURRENT_VERSION' but branch is '$BRANCH_NAME'"
                echo "Updating $CHART_FILE to version $BRANCH_NAME"
                yq eval -i ".version = \"$BRANCH_NAME\"" "$CHART_FILE"
                git add "$CHART_FILE"
                CHANGED=true
              else
                echo "Version in $CHART_FILE already matches branch name: $CURRENT_VERSION"
              fi
            fi
          done
          
          if [ "$CHANGED" = true ]; then
            git commit -m "chore: update chart versions to $BRANCH_NAME"
            git push
            echo "version_changed=true" >> $GITHUB_OUTPUT
            echo "Versions updated and committed. Stopping workflow - new run will be triggered."
          else
            echo "All chart versions already match branch name"
            echo "version_changed=false" >> $GITHUB_OUTPUT
          fi

      # Update Chart.yaml to append -beta to version if not on main
      - name: Update Chart Version for Pre-Releases
        if: github.ref_name != 'main' && steps.version_check.outputs.version_changed != 'true'
        run: |
          for CHART_FILE in ./helm/*/Chart.yaml; do
            if [ -f "$CHART_FILE" ]; then
              echo "Updating chart version in $CHART_FILE"
              yq eval -i '.version += "-beta"' "$CHART_FILE"
            fi
          done

      - name: Run chart-releaser
        if: steps.version_check.outputs.version_changed != 'true'
        uses: helm/chart-releaser-action@v1.7.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        with:
          #looks for subdirectoryies with Chart.yaml files, so point at parent dir
          charts_dir: ./helm
          # if on main, don;t overwrite existing, mark as latest.
          # If on version branch, always publish so that we get new charts as we merge in changes pre-release
          skip_existing: ${{ github.ref_name == 'main' }}
          mark_as_latest: ${{ github.ref_name == 'main' }}
